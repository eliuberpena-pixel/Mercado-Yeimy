<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mini Tienda</title>
<style>
body { font-family: Arial, sans-serif; margin:0; background:#f5f5f5; }
.hidden { display:none; }
header { background: #0a7cff; color: white; padding: 10px; display: flex; justify-content: space-between; align-items: center; }
button { padding: 8px 12px; border:none; border-radius:5px; background:#0a7cff; color:white; margin:2px; }
input, select { width:100%; padding:8px; margin:5px 0; }
#productos { display:grid; grid-template-columns: repeat(auto-fill, minmax(160px,1fr)); gap:10px; padding:10px; }
.producto { background:white; border-radius:10px; padding:10px; text-align:center; }
.producto img { width:100%; border-radius:10px; }
#carritoPanel { position:fixed; bottom:0; left:0; right:0; background:white; max-height:80%; overflow:auto; border-top:2px solid #ccc; display:none; padding:10px; }
.admin { background:#ffe0e0; padding:10px; }
.estado { font-weight:bold; }
</style>
</head>
<body>

<!-- LOGIN -->
<div id="login">
  <h2>Bienvenido</h2>
  <div>
    <button onclick="mostrarClienteForm()">Cliente</button>
    <button onclick="mostrarAdminForm()">Administrador</button>
  </div>

  <!-- Cliente -->
  <div id="clienteForm" class="hidden">
    <h3>Registro / Login Cliente</h3>
    <input id="regNombre" placeholder="Nombre">
    <input id="regTelefono" placeholder="Tel√©fono">
    <input id="regPass" type="password" placeholder="Contrase√±a">
    <button onclick="registrarCliente()">Registrarse</button>

    <hr>
    <h4>Ya tienes cuenta?</h4>
    <input id="loginTelefono" placeholder="Tel√©fono">
    <input id="loginPass" type="password" placeholder="Contrase√±a">
    <button onclick="loginCliente()">Iniciar sesi√≥n</button>
  </div>

  <!-- Admin -->
  <div id="adminForm" class="hidden">
    <h3>Administrador</h3>
    <input type="text" id="adminNumero" placeholder="N√∫mero">
    <input type="password" id="adminPass" placeholder="Contrase√±a">
    <button onclick="loginAdmin()">Entrar</button>
  </div>
</div>

<!-- TIENDA -->
<div id="tienda" class="hidden">

<header>
  <span id="nombreTiendaHeader">Mini Tienda</span>
  <div>
    <button onclick="abrirCarrito()">Carrito</button>
    <button id="btnAdmin" class="hidden" onclick="abrirAdmin()">‚öôÔ∏è</button>
  </div>
</header>

<select onchange="filtrarCategoria(this.value)">
  <option value="todos">Todos</option>
  <option value="cafe">Caf√©</option>
  <option value="pan">Panader√≠a</option>
</select>

<div id="productos"></div>

</div>

<!-- PERFIL DEL CLIENTE -->
<div id="perfilCliente" class="hidden admin" style="background:#e0f7ff;padding:10px;">
  <h3>Mi perfil</h3>
  <label>Nombre:</label>
  <input id="perfilNombre">
  <label>Tel√©fono:</label>
  <input id="perfilTelefono">
  <label>Contrase√±a:</label>
  <input id="perfilPassword" type="password">
  <button onclick="guardarPerfil()">Guardar perfil</button>
</div>

<!-- Historial del cliente -->
<div id="historialCliente" class="hidden admin" style="background:#f0ffe0;padding:10px;">
  <h3>Mis pedidos</h3>
  <div id="listaHistorial"></div>
</div>

<!-- CARRITO -->
<div id="carritoPanel">
  <h3>üõí Carrito</h3>
  <div id="listaCarrito"></div>
  <p>Total: $<span id="totalCarrito">0</span></p>
  <button onclick="enviarPedido()">Enviar pedido</button>
  <button onclick="cerrarCarrito()">Seguir comprando</button>
</div>

<!-- ADMIN -->
<div id="adminPanel" class="hidden admin">
  <h3>Pedidos</h3>
  <div id="listaPedidos"></div>

  <h3>Ajustes de tienda</h3>
  <label>Nombre de la tienda:</label>
  <input id="nombreTiendaInput" placeholder="Nombre de la tienda">
  <label>WhatsApp de contacto:</label>
  <input id="whatsappInput" placeholder="50712345678">
  <button onclick="guardarAjustes()">Guardar ajustes</button>
</div>

<script>
const ADMIN_PASS = "0012";
const ADMIN_NUM = "56666168"; // usuario administrador
let ajustes = JSON.parse(localStorage.getItem("ajustes")) || { nombreTienda: "Mini Tienda", whatsapp: "5070000000" };

let productos = [
  {id:1, nombre:"Caf√© Latte", precio:2, categoria:"cafe", img:"https://via.placeholder.com/150", cantidad:1},
  {id:2, nombre:"Capuccino", precio:2.5, categoria:"cafe", img:"https://via.placeholder.com/150", cantidad:1},
  {id:3, nombre:"Pan dulce", precio:1.5, categoria:"pan", img:"https://via.placeholder.com/150", cantidad:1}
];

let carrito = [];

// Cargar ajustes al iniciar
document.getElementById("nombreTiendaHeader").innerText = ajustes.nombreTienda;
document.getElementById("nombreTiendaInput").value = ajustes.nombreTienda;
document.getElementById("whatsappInput").value = ajustes.whatsapp;

// Mostrar formularios
function mostrarClienteForm(){ clienteForm.classList.remove("hidden"); adminForm.classList.add("hidden"); }
function mostrarAdminForm(){ adminForm.classList.remove("hidden"); clienteForm.classList.add("hidden"); }

// Registro cliente
function registrarCliente(){
  const nombre = regNombre.value.trim();
  const telefono = regTelefono.value.trim();
  const pass = regPass.value.trim();
  if(!nombre || !telefono || !pass){ alert("Completa todos los campos"); return; }

  let clientes = JSON.parse(localStorage.getItem("clientes"))||[];
  if(clientes.find(c=>c.telefono===telefono)){
    alert("Cliente ya registrado. Inicia sesi√≥n");
    return;
  }

  clientes.push({ nombre, telefono, password: pass });
  localStorage.setItem("clientes", JSON.stringify(clientes));

  localStorage.setItem("usuario", JSON.stringify({ tipo:"cliente", nombre, telefono }));
  iniciarTienda();
}

// Login cliente
function loginCliente(){
  const telefono = loginTelefono.value.trim();
  const pass = loginPass.value.trim();

  let clientes = JSON.parse(localStorage.getItem("clientes"))||[];
  const cliente = clientes.find(c=>c.telefono===telefono && c.password===pass);

  if(!cliente){ alert("Tel√©fono o contrase√±a incorrectos"); return; }

  localStorage.setItem("usuario", JSON.stringify({ tipo:"cliente", nombre:cliente.nombre, telefono:cliente.telefono }));
  iniciarTienda();
}

// Login admin
function loginAdmin(){
  const numero = adminNumero.value.trim();
  const pass = adminPass.value.trim();
  if(numero===ADMIN_NUM && pass===ADMIN_PASS){
    localStorage.setItem("usuario", JSON.stringify({ tipo:"admin", numero:ADMIN_NUM }));
    iniciarTienda();
  } else alert("N√∫mero o contrase√±a incorrectos");
}

// Iniciar tienda
function iniciarTienda(){
  login.classList.add("hidden");
  tienda.classList.remove("hidden");
  cargarProductos();
  verificarAdmin();
  mostrarPerfil();
  mostrarHistorial();
}

// Productos
function cargarProductos(){
  productosDiv.innerHTML="";
  productos.forEach(p=>{
    productosDiv.innerHTML+=`
    <div class="producto">
      <img src="${p.img}">
      <h4>${p.nombre}</h4>
      <p>$${p.precio}</p>
      <button onclick="agregar(${p.id})">Agregar</button>
    </div>`;
  });
}

function agregar(id){
  const p = productos.find(x=>x.id===id);
  carrito.push(p);
  alert("Agregado");
}

// Carrito
function abrirCarrito(){carritoPanel.style.display="block"; renderCarrito();}
function cerrarCarrito(){carritoPanel.style.display="none";}
function renderCarrito(){
  listaCarrito.innerHTML="";
  let total=0;
  carrito.forEach((p,i)=>{
    total+=p.precio;
    listaCarrito.innerHTML+=`${p.nombre} - $${p.precio} <button onclick="quitar(${i})">‚ùå</button><br>`;
  });
  totalCarrito.innerText = total.toFixed(2);
}
function quitar(i){ carrito.splice(i,1); renderCarrito(); }

// Ajustes
function guardarAjustes(){
  ajustes.nombreTienda = nombreTiendaInput.value || ajustes.nombreTienda;
  ajustes.whatsapp = whatsappInput.value || ajustes.whatsapp;
  localStorage.setItem("ajustes", JSON.stringify(ajustes));
  nombreTiendaHeader.innerText = ajustes.nombreTienda;
  alert("Ajustes guardados ‚úÖ");
}

// Pedidos
function enviarPedido(){
  const usuario = JSON.parse(localStorage.getItem("usuario"));
  const pedido = { id:Date.now(), fecha:new Date().toLocaleString(), cliente:usuario, productos:carrito, total:carrito.reduce((a,b)=>a+b.precio,0), estado:"Pendiente" };
  let pedidos = JSON.parse(localStorage.getItem("pedidos"))||[];
  pedidos.push(pedido);
  localStorage.setItem("pedidos",JSON.stringify(pedidos));

  let msg=`üßæ NUEVO PEDIDO%0AID: ${pedido.id}%0ACliente: ${usuario.nombre}%0ATotal: $${pedido.total}`;
  window.open(`https://wa.me/${ajustes.whatsapp}?text=${msg}`);

  carrito=[];
  cerrarCarrito();
  mostrarHistorial();
}

// Admin
function abrirAdmin(){ adminPanel.classList.toggle("hidden"); renderPedidos(); }
function verificarAdmin(){ const u = JSON.parse(localStorage.getItem("usuario")); if(u.tipo==="admin") btnAdmin.classList.remove("hidden"); }
function renderPedidos(){
  let pedidos = JSON.parse(localStorage.getItem("pedidos"))||[];
  listaPedidos.innerHTML="";
  pedidos.forEach(p=>{
    let botones="";
    if(p.estado==="Pendiente") botones=`<button onclick="estado(${p.id},'Aceptado')">Aceptar</button> <button onclick="cancelarPedido(${p.id})">Cancelar</button>`;
    listaPedidos.innerHTML+=`
      <div>
        <b>#${p.id}</b> ${p.cliente.nombre} - $${p.total} <span class="estado">${p.estado}</span><br>
        ${botones}
      </div><hr>`;
  });
}
function estado(id, nuevoEstado){
  let pedidos = JSON.parse(localStorage.getItem("pedidos"));
  let p = pedidos.find(x=>x.id===id);
  p.estado = nuevoEstado;
  localStorage.setItem("pedidos",JSON.stringify(pedidos));

  let msg=`‚úÖ PEDIDO ${nuevoEstado.toUpperCase()}%0AID: ${p.id}%0ATotal: $${p.total}`;
  window.open(`https://wa.me/${p.cliente.telefono}?text=${msg}`);
  renderPedidos();
}
function cancelarPedido(id){
  let pedidos = JSON.parse(localStorage.getItem("pedidos"));
  let p = pedidos.find(x=>x.id===id);
  if(p.estado!=="Pendiente"){ alert("No se puede cancelar"); return; }
  p.estado = "Cancelado";
  localStorage.setItem("pedidos",JSON.stringify(pedidos));
  alert("Pedido cancelado ‚úÖ");
  renderPedidos();
}

// Perfil cliente editable
function mostrarPerfil(){
  const usuario = JSON.parse(localStorage.getItem("usuario"));
  if(usuario.tipo!=="cliente") return;
  perfilCliente.classList.remove("hidden");
  perfilNombre.value = usuario.nombre;
  perfilTelefono.value = usuario.telefono;
}
function guardarPerfil(){
  const usuario = JSON.parse(localStorage.getItem("usuario"));
  let clientes = JSON.parse(localStorage.getItem("clientes")) || [];
  const cliente = clientes.find(c=>c.telefono===usuario.telefono);

  if(cliente){
    cliente.nombre = perfilNombre.value || cliente.nombre;
    cliente.telefono = perfilTelefono.value || cliente.telefono;
    if(perfilPassword.value) cliente.password = perfilPassword.value;
    localStorage.setItem("clientes", JSON.stringify(clientes));

    usuario.nombre = cliente.nombre;
    usuario.telefono = cliente.telefono;
    localStorage.setItem("usuario", JSON.stringify(usuario));

    alert("Perfil actualizado ‚úÖ");
    mostrarHistorial();
  }
}

// Historial cliente
function mostrarHistorial(){
  const usuario = JSON.parse(localStorage.getItem("usuario"));
  if(usuario.tipo!=="cliente") return;
  historialCliente.classList.remove("hidden");

  const pedidos = JSON.parse(localStorage.getItem("pedidos")) || [];
  const misPedidos = pedidos.filter(p => p.cliente.telefono === usuario.telefono);

  listaHistorial.innerHTML = "";
  misPedidos.forEach(p => {
    let btnCancelar = p.estado==="Pendiente"?`<button onclick="cancelarPedidoCliente(${p.id})">Cancelar</button>`:"";
    let listaProductos="";
    p.productos.forEach(prod=>{
      listaProductos += `- ${prod.nombre} x${prod.cantidad} $${(prod.precio*prod.cantidad).toFixed(2)}<br>`;
    });
    listaHistorial.innerHTML += `
      <div style="border:1px solid #ccc; margin:5px; padding:5px; border-radius:5px;">
        <b>Pedido #${p.id}</b><br>
        Fecha: ${p.fecha}<br>
        Productos:<br>${listaProductos}
        Total: $${p.total.toFixed(2)}<br>
        Estado: <span class="estado">${p.estado}</span><br>
        ${btnCancelar}
      </div>`;
  });
}
function cancelarPedidoCliente(id){
  let pedidos = JSON.parse(localStorage.getItem("pedidos")) || [];
  const pedido = pedidos.find(p => p.id===id);
  if(!pedido || pedido.estado !== "Pendiente"){ alert("No se puede cancelar"); return; }
  pedido.estado="Cancelado";
  localStorage.setItem("pedidos", JSON.stringify(pedidos));
  alert("Pedido cancelado ‚úÖ");
  mostrarHistorial();
}

// Filtrar categor√≠as
function filtrarCategoria(cat){
  productosDiv.innerHTML="";
  productos.filter(p=>cat==="todos"?true:p.categoria===cat).forEach(p=>{
    productosDiv.innerHTML+=`
    <div class="producto">
      <img src="${p.img}">
      <h4>${p.nombre}</h4>
      <p>$${p.precio}</p>
      <button onclick="agregar(${p.id})">Agregar</button>
    </div>`;
  });
}
</script>
</body>
</html>
